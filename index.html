<!DOCTYPE html>
<html>
<head>
<style>
  body { margin:0; background:black; }
  h2 { text-align:center; color:white; }
  canvas { display:block; margin:auto; }
</style>
</head>
<body>

<h2 id="demo"></h2>
<canvas id="earthCanvas" width="1024" height="512"></canvas>

<script>
const canvas = document.getElementById("earthCanvas");
const ctx = canvas.getContext("2d");

const width = 1024;
const height = 512;

const earthImg = new Image();
earthImg.src = "earth_map.png";

function updateTime() {
  const now = new Date();
  document.getElementById("demo").innerHTML = now.toUTCString();
}

function getSolarDeclination(date) {
  const dayOfYear = Math.floor(
    (date - new Date(date.getFullYear(), 0, 0)) / 86400000
  );
  return 23.44 * Math.sin((2 * Math.PI / 365) * (dayOfYear - 81));
}

function drawDayNight() {
  const now = new Date();

  ctx.drawImage(earthImg, 0, 0, width, height);
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;

  const utcHours = now.getUTCHours() + now.getUTCMinutes()/60;
  const sunLon = (utcHours / 24) * 360 - 180;

  const decl = getSolarDeclination(now);

  // Convert sun to 3D vector
  const sunLatRad = decl * Math.PI/180;
  const sunLonRad = sunLon * Math.PI/180;

  const sx = Math.cos(sunLatRad) * Math.cos(sunLonRad);
  const sy = Math.cos(sunLatRad) * Math.sin(sunLonRad);
  const sz = Math.sin(sunLatRad);

  for (let y = 0; y < height; y++) {
    const lat = 90 - (y / height) * 180;
    const latRad = lat * Math.PI/180;

    for (let x = 0; x < width; x++) {
      const lon = (x / width) * 360 - 180;
      const lonRad = lon * Math.PI/180;

      const px = Math.cos(latRad) * Math.cos(lonRad);
      const py = Math.cos(latRad) * Math.sin(lonRad);
      const pz = Math.sin(latRad);

      const dot = px*sx + py*sy + pz*sz;

      const index = (y * width + x) * 4;

      if (dot < 0) {
        const darkness = Math.min(1, -dot);
        data[index] *= (1 - darkness * 0.8);
        data[index+1] *= (1 - darkness * 0.8);
        data[index+2] *= (1 - darkness * 0.6);
      }
    }
  }

  ctx.putImageData(imageData, 0, 0);
}

function update() {
  updateTime();
  drawDayNight();
}

earthImg.onload = function() {
  update();
  setInterval(update, 1000);
};
</script>

</body>
</html>
