<!DOCTYPE html>
<html>
<head>
<style>
  body { margin:0; background:black; }
  h2 { text-align:center; color:white; }
  canvas { display:block; margin:auto; }
</style>
</head>
<body>

<h2 id="demo"></h2>
<canvas id="earthCanvas" width="1024" height="512"></canvas>

<script>
const canvas = document.getElementById("earthCanvas");
const ctx = canvas.getContext("2d");

const width = 1024;
const height = 512;

const earthDay = new Image();
earthDay.src = "earth_map.png";

const earthNight = new Image();
earthNight.src = "earth_map_night.png";

function updateTime() {
  const now = new Date();
  document.getElementById("demo").innerHTML = now.toUTCString();
}

function getSolarDeclination(date) {
  const dayOfYear = Math.floor(
    (date - new Date(date.getFullYear(), 0, 0)) / 86400000
  );
  return 23.44 * Math.sin((2 * Math.PI / 365) * (dayOfYear - 81));
}

function drawDayNight() {
  const now = new Date();

  ctx.drawImage(earthDay, 0, 0, width, height);
  const dayData = ctx.getImageData(0, 0, width, height);

  ctx.drawImage(earthNight, 0, 0, width, height);
  const nightData = ctx.getImageData(0, 0, width, height);

  const finalData = ctx.createImageData(width, height);

  const utcHours = now.getUTCHours() + now.getUTCMinutes()/60;
  const sunLon = (utcHours / 24) * 360 - 180;
  const decl = getSolarDeclination(now);

  const sunLatRad = decl * Math.PI/180;
  const sunLonRad = sunLon * Math.PI/180;

  const sx = Math.cos(sunLatRad) * Math.cos(sunLonRad);
  const sy = Math.cos(sunLatRad) * Math.sin(sunLonRad);
  const sz = Math.sin(sunLatRad);

  const twilightWidth = 0.03;

  for (let y = 0; y < height; y++) {
    const lat = 90 - (y / height) * 180;
    const latRad = lat * Math.PI/180;

    for (let x = 0; x < width; x++) {
      const lon = (x / width) * 360 - 180;
      const lonRad = lon * Math.PI/180;

      const px = Math.cos(latRad) * Math.cos(lonRad);
      const py = Math.cos(latRad) * Math.sin(lonRad);
      const pz = Math.sin(latRad);

      const dot = px*sx + py*sy + pz*sz;
      const i = (y * width + x) * 4;

      let blend;

      if (dot > twilightWidth) {
        blend = 0; 
      } 
      else if (dot < -twilightWidth) {
        blend = 1; 
      } 
      else {
        blend = (twilightWidth - dot) / (2 * twilightWidth);
      }

      finalData.data[i] =
        dayData.data[i] * (1 - blend) + nightData.data[i] * blend;

      finalData.data[i+1] =
        dayData.data[i+1] * (1 - blend) + nightData.data[i+1] * blend;

      finalData.data[i+2] =
        dayData.data[i+2] * (1 - blend) + nightData.data[i+2] * blend;

      finalData.data[i+3] = 255;
    }
  }

  ctx.putImageData(finalData, 0, 0);
}

function update() {
  updateTime();
  drawDayNight();
}

let loaded = 0;
earthDay.onload = () => { if (++loaded === 2) start(); };
earthNight.onload = () => { if (++loaded === 2) start(); };

function start() {
  update();
  setInterval(update, 1000);
}
</script>

</body>
</html>
